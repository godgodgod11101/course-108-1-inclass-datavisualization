---
title: "osmdata"
author: "jacky wang"
date: "2019/11/27"
output: html_document
---

```{r setup, include=FALSE}

library(knitr)

opts_chunk$set(echo = TRUE, message = F, warning = F, eval=T)

# windows檔名不要有"-"號

```

```{r package, include=FALSE}

library(readr) #資料匯入
library(dplyr) #資料整理（slice、select、filter、mutate）
library(tidyr) #資料整理（gather、spread）
library(stringr) #處理字串
library(lubridate) #時間資料處理（ymd）
library(ggplot2) #作圖
library(magrittr) # %<>%
library(showtext) #從字型檔讀取字型，並在繪圖時使用

library(grDevices) #不同色彩空間的十六進制代碼呈現（#598C73）
library(scales) #show_col()：螢幕立即顯示顏色
library(colorspace) #調色盤選擇及ggplot應用工具
library(shiny) #支援套件
library(shinyjs) #支援套件

library(sf)

```



# osmdata

OSM: Open Street Map （向量資料）; link: <https://www.openstreetmap.org>

步驟：1. 連結至OSM
      2. 搜尋區域
      3. 按「匯出」
      4. 由最左邊開始逆時針

```{r}

library(osmdata)

```

## overpass query

步驟：1. 連結至OSM
      2. 搜尋區域
      3. 按「匯出」
      4. bbox由最左邊開始逆時針貼上


key-value(osm feature)查詢：<https://wiki.openstreetmap.org/wiki/Map_Features>

```{r}

bbox_NTPU <- opq(
  bbox = c(121.3583, 24.9381, 121.3771, 24.9483)
)

bbox_NTPU %>% 
  add_osm_feature(
    key = "building", value = "residential"
  ) %>% 
  osmdata_sf() -> 
  sf_NTPU 

sf_NTPU$osm_polygons %>% 
  ggplot() + 
  geom_sf()

```



# 20191127正課

## 網頁下載

從網頁上直接匯出osm檔來繪圖
優點：簡單又直覺
缺點：資料量太大（一次匯出所有圖層）

```{r}

#dir.create("osmDownload")

#查看有哪些圖層
st_layers("osmDownload/map_SYSmemorialHall.osm")

#取出line圖層資料（為sfo）
st_read("osmDownload/map_SYSmemorialHall.osm", layer="lines") -> 
  sf_SYSmemorialHall_lines 

sf_SYSmemorialHall_lines

```

```{r}

sf_SYSmemorialHall_lines %>% 
  ggplot() + 
  geom_sf()

sf_SYSmemorialHall_lines %>% 
  filter(
    !is.na(name)    # !: not
  ) %>% 
  ggplot() + 
  geom_sf()

```

```{r}

st_read("osmDownload/map_SYSmemorialHall.osm",layer="points") -> 
  sf_SYSmemorialHall_points

sf_SYSmemorialHall_points %>% 
  ggplot() + 
  geom_sf()

```

```{r}

st_read(dsn = "osmDownload/map_SYSmemorialHall.osm", layer = "multipolygons") -> 
  sf_SYSmemorialHall_multipolygons

sf_SYSmemorialHall_multipolygons %>% 
  ggplot() + 
  geom_sf() + 
  theme_classic() -> 
  plot_SYSmemorialHall_multipolygons

plot_SYSmemorialHall_multipolygons + 
  geom_sf(
    data = sf_SYSmemorialHall_points
  ) + 
  geom_sf(
    data = sf_SYSmemorialHall_lines %>% 
      filter(
        !is.na(name)
      )
  )

```







```{r}

st_layers("mapSSairport.osm") -> 
  layers_mapSSairport

layers_mapSSairport

```

```{r}

st_read(
  dsn = "mapSSairport.osm", 
  layer = "multipolygons"
) -> 
  sf_mapSSairport_multipolygons

st_read(
  dsn = "mapSSairport.osm", 
  layer = "points"
) -> 
  sf_mapSSairport_points

st_read(
  dsn = "mapSSairport.osm", 
  layer = "lines"
) -> 
  sf_mapSSairport_lines

```

```{r}

sf_mapSSairport_multipolygons %>% 
  ggplot() + 
  geom_sf(
    fill = "grey"
  ) + 
  geom_sf(
    data = sf_mapSSairport_points, 
    color = "red"
  ) + 
  geom_sf(
    data = sf_mapSSairport_lines
  ) + 
  theme_classic()

```

# Overpass query

```{r}

opq(
  bbox = c(121.55577, 25.03672, 121.56520, 25.04181)
) -> 
  opq_SYSmemorial

opq_SYSmemorial %>% 
  add_osm_feature(
    key = "tourism", 
    value = "attraction" 
  ) %>% 
  osmdata_sf() -> 
  osm_SYSmemorial

osm_SYSmemorial$osm_polygons %>% 
  ggplot() + 
  geom_sf() + 
  theme_classic()

```

```{r}

opq(
  bbox = c(121.4616,25.1050,121.6058,24.9894) 
) -> 
  bbox_taipei

bbox_taipei %>% 
  add_osm_feature(
    key="railway", value="subway"
  ) %>%
  osmdata_sf() -> map_taipei_subway

map_taipei_subway

```



```{r}

map_taipei_subway$osm_lines %>%
  mutate(
    length=st_length(geometry),
    shortname=str_replace(name,"捷運","") %>%
      str_extract("[:graph:]+(?=線)")
  ) -> sf_tpe_mrt

```

```{r}

source("https://www.dropbox.com/s/8ndtvzqbdb4cb93/data_visulaization_pk.R?dl=1")

```


```{r}


sf_tpe_mrt %>%
group_by(
    shortname
  ) %>%
  summarise(
    geometry=st_union(geometry)
  ) %>%
  ungroup() %>%
  na.omit() -> sf_tpe_mrt


sf_tpe_mrt %>%
  ggplot()+geom_sf(
    aes(color=shortname, fill=shortname), size=1
  ) +
  geom_sf_text(
    aes(label=shortname)
  )+
  labs(title="台北捷運路線圖")


```


